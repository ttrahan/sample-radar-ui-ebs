# language setting
language: node_js

# version numbers, testing against two versions of node
node_js:
  - 0.10.33

env:
  global:
    - AWS_EB_APPLICATION=sample-radar-ui-ebs-cl
    - AWS_EB_ENVIRONMENT=sample-radar-ui-ebs-cl
    - AWS_S3_BUCKET=elasticbeanstalk-us-east-1-288971733297
    - AWS_REGION=us-east-1
    - ACCOUNT_IDENTIFIER=shippable.ttrahan
    - AWS_DEPLOY_JSON=Dockerrun.aws.json.$ACCOUNT_IDENTIFIER.$AWS_EB_APPLICATION
    - AWS_DOCKER_CONFIG=dockerconfig.$ACCOUNT_IDENTIFIER.$AWS_EB_APPLICATION

build:
  pre_ci:
    - docker build -t ttrahan/$AWS_EB_APPLICATION:latest .
    - node --version
    - SUDO=$(which sudo) && $SUDO pip install awscli
  pre_ci_boot:
    image_name: ttrahan/$AWS_EB_APPLICATION
    image_tag: latest
    pull: false
    options: --privileged=true
  ci:
    - npm install
  post_ci:
    - docker tag -f ttrahan/$AWS_EB_APPLICATION:latest ttrahan/$AWS_EB_APPLICATION:bld.$BRANCH.$BUILD_NUMBER
    - docker push ttrahan/$AWS_EB_APPLICATION:bld.$BRANCH.$BUILD_NUMBER
    - cat Dockerrun.aws.json | sed "s/<IMAGE_NAME>/ttrahan\/$AWS_EB_APPLICATION/" | sed "s/<TAG>/$BRANCH.$BUILD_NUMBER/" | sed "s/<DOCKER_CONFIG>/$AWS_DEPLOY_JSON.$BRANCH.$BUILD_NUMBER/" > $AWS_DEPLOY_JSON.$BRANCH.$BUILD_NUMBER
    - aws s3 cp $AWS_DEPLOY_JSON.$BRANCH.$BUILD_NUMBER s3://$AWS_S3_BUCKET --region=$AWS_REGION
    - aws s3 cp /root/finalcfg.json s3://$AWS_S3_BUCKET/$AWS_DOCKER_CONFIG.$BRANCH.$BUILD_NUMBER --region=$AWS_REGION
    - aws elasticbeanstalk create-application-version --application-name $AWS_EB_APPLICATION --version-label $ACCOUNT_IDENTIFIER.$AWS_EB_APPLICATION.$BRANCH.$BUILD_NUMBER --source-bundle S3Bucket=$AWS_S3_BUCKET,S3Key=$AWS_DEPLOY_JSON.$BRANCH.$BUILD_NUMBER --region=$AWS_REGION
    - sleep 20s #This sleep is to make sure the image is available in the registry
    - aws elasticbeanstalk update-environment --environment-name $AWS_EB_ENVIRONMENT --version-label $ACCOUNT_IDENTIFIER.$AWS_EB_APPLICATION.$BRANCH.$BUILD_NUMBER --region=$AWS_REGION

integrations:
    hub:
      - integrationName: "Docker Hub"
        type: docker
        branches:
          only:
            - new-build-system
